# app/services/nlu/llm_engine.rb
module Nlu
  class LlmEngine
    def self.call(text:,products:)
      new(text,products).call
    end

    def initialize(text,products)
      @text = text
      @products = products
      
    end
    
    def llmSearchProduct
    end 

    def call
      response = ask_llm(@text,@products)
      # content = response.choices.first.message[:content]
      # parsed = JSON.parse(content) # à¹à¸›à¸¥à¸‡à¹€à¸›à¹‡à¸™ hash
      # product = parsed.dig("entities", "product")
      # Rails.logger.debug("ðŸ§Ÿâ€â™€ï¸ðŸ§Ÿâ€â™€ï¸ðŸ§Ÿâ€â™€ï¸ðŸ§Ÿâ€â™€ï¸ðŸ§Ÿâ€â™€ï¸"+response)
      # {
      #   intent: json["intent"] || "UNKNOWN",
      #   confidence: json["confidence"] || 0.8, # à¸ˆà¸°à¹ƒà¸«à¹‰ fix 0.8 à¹„à¸§à¹‰à¸à¹‡à¹„à¸”à¹‰
      #   entities: (json["entities"] || {}).symbolize_keys,
      #   # message: json["message"] || "AI à¸à¸³à¸¥à¸±à¸‡à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡"
      # }
      response
      
    
    rescue error => e
      Rails.logger.error("LLM error: #{e.message}")
      { intent: "UNKNOWN", confidence: 0.0, entities: {} }
    end

    private

    def ask_llm(text,products)
      
        if products.blank? 
          items = []
        else
          items = products.first(5).map do |p|
            { id: p._id, name: p.productname, price: p.productsale6, stock: p.productstock.present? }
          end
        end
       
      prompt = build_prompt(text,items)
      
      openai = OpenAI::Client.new(
        api_key: Rails.application.credentials.OPENAI_API_KEY
      )
      response = openai.chat.completions.create(
        model: :"gpt-4.1-mini",
        messages: [
          { role: "system", content: "à¸•à¸­à¸šà¹€à¸›à¹‡à¸™à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡" },
          { role: "user", content: prompt }
        ]
      )
      content = response.choices.first.message[:content]
      
      
    end

    def build_prompt(text,items)
    <<~PROMPT
      à¸„à¸¸à¸“à¹€à¸›à¹‡à¸™à¸•à¸±à¸§à¸Šà¹ˆà¸§à¸¢à¸—à¸µà¹ˆà¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸ˆà¸²à¸à¸¥à¸¹à¸à¸„à¹‰à¸²à¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸šà¸ªà¸´à¸™à¸„à¹‰à¸²à¹ƒà¸™à¸£à¹‰à¸²à¸™à¸§à¸±à¸ªà¸”à¸¸à¸à¹ˆà¸­à¸ªà¸£à¹‰à¸²à¸‡à¸£à¸°à¸”à¸±à¸šà¸¡à¸·à¸­à¸­à¸²à¸Šà¸µà¸ž
      
      à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆà¸‚à¸­à¸‡à¸„à¸¸à¸“à¸„à¸·à¸­:
      - à¸•à¸­à¸šà¸„à¸³à¸–à¸²à¸¡à¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸šà¸ªà¸´à¸™à¸„à¹‰à¸²
      - à¹à¸™à¸°à¸™à¸³à¸ªà¸´à¸™à¸„à¹‰à¸²à¸—à¸µà¹ˆà¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡
      - à¹€à¸Šà¹‡à¸„à¸£à¸²à¸„à¸² / à¸£à¸°à¸šà¸¸à¸ªà¸•à¹‡à¸­à¸à¸ˆà¸²à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¹ƒà¸«à¹‰
      - à¸„à¸³à¸™à¸§à¸“à¸ˆà¸³à¸™à¸§à¸™à¸§à¸±à¸ªà¸”à¸¸à¸à¹ˆà¸­à¸ªà¸£à¹‰à¸²à¸‡
      - à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸ à¸²à¸žà¸ªà¸´à¸™à¸„à¹‰à¸²à¹€à¸žà¸·à¹ˆà¸­à¸—à¸²à¸¢à¸£à¸¸à¹ˆà¸™/à¸‚à¸™à¸²à¸”
      - à¹€à¸ªà¸™à¸­à¸ªà¸´à¸™à¸„à¹‰à¸²à¸—à¸µà¹ˆà¸‚à¸²à¸¢à¸„à¸¹à¹ˆà¸à¸±à¸™ (Upsell)
      - à¸›à¸´à¸”à¸à¸²à¸£à¸‚à¸²à¸¢à¹ƒà¸«à¹‰à¹€à¸£à¹‡à¸§à¸—à¸µà¹ˆà¸ªà¸¸à¸”
      - à¸•à¸­à¸šà¸”à¹‰à¸§à¸¢à¸ à¸²à¸©à¸²à¸‡à¹ˆà¸²à¸¢ à¸ªà¸¸à¸ à¸²à¸ž à¸ªà¹„à¸•à¸¥à¹Œà¸žà¸™à¸±à¸à¸‡à¸²à¸™à¸‚à¸²à¸¢à¸£à¹‰à¸²à¸™à¸§à¸±à¸ªà¸”à¸¸
      
      à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸£à¹‰à¸²à¸™:
      à¸Šà¸·à¹ˆà¸­à¸£à¹‰à¸²à¸™: à¸šà¹‰à¸²à¸™à¸ªà¸¢à¸²à¸¡à¸§à¸±à¸ªà¸”à¸¸à¹ˆà¸à¹ˆà¸­à¸ªà¸£à¹‰à¸²à¸‡
      à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆ: à¸ˆ.à¸žà¸£à¸°à¸™à¸„à¸£à¸¨à¸£à¸µà¸­à¸¢à¸¸à¸˜à¸¢à¸²
      à¹€à¸§à¸¥à¸²à¸—à¸³à¸à¸²à¸£: 24 à¸Šà¸¡.
      à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸ˆà¸±à¸”à¸ªà¹ˆà¸‡à¸Ÿà¸£à¸µ: 20 à¸à¸¡.
      à¹€à¸šà¸­à¸£à¹Œà¸•à¸´à¸”à¸•à¹ˆà¸­: 094-161-4447
      
      à¸›à¸£à¸°à¹€à¸ à¸—à¸ªà¸´à¸™à¸„à¹‰à¸²à¸—à¸µà¹ˆà¸£à¹‰à¸²à¸™à¸‚à¸²à¸¢:
      - à¸›à¸¹à¸™à¸‹à¸µà¹€à¸¡à¸™à¸•à¹Œà¸—à¸¸à¸à¸Šà¸™à¸´à¸”
      - à¹€à¸«à¸¥à¹‡à¸à¹€à¸ªà¹‰à¸™ à¹€à¸«à¸¥à¹‡à¸à¸à¸¥à¹ˆà¸­à¸‡
      - à¸ªà¸µà¸—à¸²à¸šà¹‰à¸²à¸™ à¸ªà¸µà¸‡à¸²à¸™à¹€à¸«à¸¥à¹‡à¸
      - à¸­à¸¸à¸›à¸à¸£à¸“à¹Œà¸›à¸£à¸°à¸›à¸² PVC
      - à¸­à¸¸à¸›à¸à¸£à¸“à¹Œà¹„à¸Ÿà¸Ÿà¹‰à¸²
      - à¸à¸£à¸°à¹€à¸šà¸·à¹‰à¸­à¸‡ à¸›à¸¹à¸žà¸·à¹‰à¸™/à¸œà¸™à¸±à¸‡
      - à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸¡à¸·à¸­à¸Šà¹ˆà¸²à¸‡
      - à¸§à¸±à¸ªà¸”à¸¸à¸à¹ˆà¸­à¸ªà¸£à¹‰à¸²à¸‡à¸—à¸±à¹ˆà¸§à¹„à¸›
      
      **à¸à¸Žà¸à¸²à¸£à¸•à¸­à¸š**
      1. à¸–à¹‰à¸²à¸¥à¸¹à¸à¸„à¹‰à¸²à¸–à¸²à¸¡à¸«à¸²à¸ªà¸´à¸™à¸„à¹‰à¸² â†’  à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸´à¸™à¸„à¹‰à¸²à¸—à¸µà¹ˆà¸«à¸²à¹€à¸ˆà¸­ (à¸ªà¸¹à¸‡à¸ªà¸¸à¸” 5 à¸£à¸²à¸¢à¸à¸²à¸£):
       #{items.to_json}
      2. à¸–à¹‰à¸²à¸¥à¸¹à¸à¸„à¹‰à¸²à¸–à¸²à¸¡à¸ˆà¸²à¸à¸£à¸¹à¸›à¸ à¸²à¸ž â†’ à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹à¸¥à¸°à¸šà¸­à¸à¸ªà¸´à¸™à¸„à¹‰à¸²à¸—à¸µà¹ˆà¸™à¹ˆà¸²à¸ˆà¸°à¹ƒà¸Šà¹ˆà¸—à¸µà¹ˆà¸ªà¸¸à¸”
      3. à¸–à¹‰à¸²à¸¥à¸¹à¸à¸„à¹‰à¸²à¸–à¸²à¸¡ â€œà¸•à¹‰à¸­à¸‡à¹ƒà¸Šà¹‰à¸­à¸°à¹„à¸£à¸”à¸µ?â€ â†’ à¹ƒà¸«à¹‰ 2 à¸•à¸±à¸§à¹€à¸¥à¸·à¸­à¸à¹à¸¥à¸°à¸šà¸­à¸à¸‚à¹‰à¸­à¸”à¸µâ€“à¸‚à¹‰à¸­à¹€à¸ªà¸µà¸¢
      4. à¸–à¹‰à¸²à¸¥à¸¹à¸à¸„à¹‰à¸²à¸–à¸²à¸¡à¸ˆà¸³à¸™à¸§à¸™à¸§à¸±à¸ªà¸”à¸¸ â†’ à¹ƒà¸«à¹‰à¸„à¸³à¸™à¸§à¸“à¸ˆà¸²à¸à¸ªà¸¹à¸•à¸£à¸¡à¸²à¸•à¸£à¸à¸²à¸™
      5. à¸•à¸­à¸šà¹à¸šà¸šà¸ªà¸±à¹‰à¸™à¸à¸£à¸°à¸Šà¸±à¸š à¹„à¸¡à¹ˆà¹€à¸§à¸´à¹ˆà¸™à¹€à¸§à¹‰à¸­
      6. 
      
      **à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸„à¸³à¸™à¸§à¸“à¸ˆà¸³à¸™à¸§à¸™à¸§à¸±à¸ªà¸”à¸¸ (à¸ªà¸¹à¸•à¸£à¸žà¸·à¹‰à¸™à¸à¸²à¸™)**
      - à¹€à¸—à¸žà¸·à¹‰à¸™ 1 à¸•à¸£.à¸¡. à¸«à¸™à¸² 5 à¸‹à¸¡. = à¸›à¸¹à¸™ 1.5â€“2 à¸–à¸¸à¸‡  
      - à¸à¹ˆà¸­à¸­à¸´à¸à¸¡à¸­à¸ 1 à¸•à¸£.à¸¡. = à¸­à¸´à¸ 50â€“55 à¸à¹‰à¸­à¸™  
      - à¸‰à¸²à¸šà¸œà¸™à¸±à¸‡ 1 à¸•à¸£.à¸¡. = à¸›à¸¹à¸™à¸‰à¸²à¸š 5â€“6 à¸à¸.  
      - à¸à¸£à¸°à¹€à¸šà¸·à¹‰à¸­à¸‡à¸žà¸·à¹‰à¸™/à¸œà¸™à¸±à¸‡ = +10% à¹€à¸œà¸·à¹ˆà¸­à¹à¸•à¸/à¸•à¸±à¸”  
      - à¸—à¹ˆà¸­ PVC à¹ƒà¸Šà¹‰à¸¡à¸²à¸•à¸£à¸à¸²à¸™à¸‚à¸™à¸²à¸”à¸•à¸²à¸¡à¸•à¸²à¸£à¸²à¸‡  
      - à¹€à¸«à¸¥à¹‡à¸à¹€à¸ªà¹‰à¸™à¸„à¸´à¸”à¸•à¸²à¸¡à¸«à¸™à¹‰à¸²à¹€à¸ªà¸²/à¸„à¸²à¸™à¸—à¸µà¹ˆà¸¥à¸¹à¸à¸„à¹‰à¸²à¸šà¸­à¸
      
      **à¸£à¸¹à¸›à¹à¸šà¸šà¸à¸²à¸£à¸›à¸´à¸”à¸à¸²à¸£à¸‚à¸²à¸¢**
      à¹ƒà¸«à¹‰à¸–à¸²à¸¡à¹€à¸ªà¸¡à¸­à¸§à¹ˆà¸²:
      - à¸ªà¸­à¸šà¸–à¸²à¸¡à¹€à¸žà¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡à¹„à¸”à¹‰à¹€à¸¥à¸¢à¸„à¹ˆà¸°
      
      à¸™à¸³à¸„à¸³à¸•à¸­à¸šà¹„à¸›à¹ƒà¸ªà¹ˆà¹ƒà¸™ _content
      
      à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸›à¸£à¸°à¹‚à¸¢à¸„à¸•à¹ˆà¸­à¹„à¸›à¸™à¸µà¹‰à¹à¸¥à¸°à¸•à¸­à¸šà¹€à¸›à¹‡à¸™ JSON à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™ à¸«à¹‰à¸²à¸¡à¸¡à¸µà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸­à¸·à¹ˆà¸™à¸™à¸­à¸à¸ˆà¸²à¸ JSON

        intent à¸•à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™à¸«à¸™à¸¶à¹ˆà¸‡à¹ƒà¸™:
        - ASK_PRICE          (à¸–à¸²à¸¡à¸£à¸²à¸„à¸²)
        - ASK_ORDER_STATUS   (à¸–à¸²à¸¡à¸ªà¸–à¸²à¸™à¸°à¸‚à¸­à¸‡à¸—à¸µà¹ˆà¸ªà¸±à¹ˆà¸‡)
        - ASK_PRODUCT_SPEC   (à¸–à¸²à¸¡à¸ªà¹€à¸›à¸„ à¹€à¸Šà¹ˆà¸™ à¸ªà¸¹à¸‡à¹€à¸—à¹ˆà¸²à¹„à¸«à¸£à¹ˆ)
        - ASK_SHIPPING_COST  (à¸–à¸²à¸¡à¸„à¹ˆà¸²à¸ªà¹ˆà¸‡, à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¸ªà¹ˆà¸‡à¸Ÿà¸£à¸µ)
        - UNKNOWN            (à¸–à¹‰à¸²à¸•à¸±à¸”à¸ªà¸´à¸™à¹ƒà¸ˆà¹„à¸¡à¹ˆà¹„à¸”à¹‰)

        
       
         à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡ JSON:         
         {"intent":"ASK_PRICE","entities":{"product":"à¸§à¸‡à¸ªà¹‰à¸§à¸¡","size":80},"message":{_content}}

      à¸›à¸£à¸°à¹‚à¸¢à¸„:
      "#{text}"
    PROMPT
      # <<~PROMPT
      #   à¸„à¸¸à¸“à¹€à¸›à¹‡à¸™à¸•à¸±à¸§à¸Šà¹ˆà¸§à¸¢à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸ˆà¸²à¸à¸¥à¸¹à¸à¸„à¹‰à¸²à¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸šà¸ªà¸´à¸™à¸„à¹‰à¸²à¹ƒà¸™à¸£à¹‰à¸²à¸™à¸§à¸±à¸ªà¸”à¸¸à¸à¹ˆà¸­à¸ªà¸£à¹‰à¸²à¸‡

      #   à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¸›à¸£à¸°à¹‚à¸¢à¸„à¸•à¹ˆà¸­à¹„à¸›à¸™à¸µà¹‰à¹à¸¥à¸°à¸•à¸­à¸šà¹€à¸›à¹‡à¸™ JSON à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™ à¸«à¹‰à¸²à¸¡à¸¡à¸µà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸­à¸·à¹ˆà¸™à¸™à¸­à¸à¸ˆà¸²à¸ JSON

      #   intent à¸•à¹‰à¸­à¸‡à¹€à¸›à¹‡à¸™à¸«à¸™à¸¶à¹ˆà¸‡à¹ƒà¸™:
      #   - ASK_PRICE          (à¸–à¸²à¸¡à¸£à¸²à¸„à¸²)
      #   - ASK_ORDER_STATUS   (à¸–à¸²à¸¡à¸ªà¸–à¸²à¸™à¸°à¸‚à¸­à¸‡à¸—à¸µà¹ˆà¸ªà¸±à¹ˆà¸‡)
      #   - ASK_PRODUCT_SPEC   (à¸–à¸²à¸¡à¸ªà¹€à¸›à¸„ à¹€à¸Šà¹ˆà¸™ à¸ªà¸¹à¸‡à¹€à¸—à¹ˆà¸²à¹„à¸«à¸£à¹ˆ)
      #   - ASK_SHIPPING_COST  (à¸–à¸²à¸¡à¸„à¹ˆà¸²à¸ªà¹ˆà¸‡, à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¸ªà¹ˆà¸‡à¸Ÿà¸£à¸µ)
      #   - UNKNOWN            (à¸–à¹‰à¸²à¸•à¸±à¸”à¸ªà¸´à¸™à¹ƒà¸ˆà¹„à¸¡à¹ˆà¹„à¸”à¹‰)

      #   entities à¹ƒà¸«à¹‰à¹ƒà¸ªà¹ˆà¹„à¸”à¹‰ à¹€à¸Šà¹ˆà¸™:
      #   - product: à¸Šà¸·à¹ˆà¸­à¸ªà¸´à¸™à¸„à¹‰à¸² à¹€à¸Šà¹ˆà¸™ "à¸§à¸‡à¸ªà¹‰à¸§à¸¡"
      #   - size: à¸‚à¸™à¸²à¸”à¹€à¸Šà¹ˆà¸™ 80 (à¸•à¸±à¸§à¹€à¸¥à¸‚)
      #   - quantity: à¸ˆà¸³à¸™à¸§à¸™à¸§à¸‡ à¹€à¸Šà¹ˆà¸™ 40 (à¸•à¸±à¸§à¹€à¸¥à¸‚)

      #   à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡ JSON:
      #   {"intent":"ASK_PRICE","entities":{"product":"à¸§à¸‡à¸ªà¹‰à¸§à¸¡","size":80}}

      #   à¸›à¸£à¸°à¹‚à¸¢à¸„:
      #   "#{text}"
      # PROMPT
    end
  end
end
